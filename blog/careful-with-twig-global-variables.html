<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//www.google-analytics.com">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Be careful with global variables in Symfony 2 Twig extensions :: Peter Mitchell :: Website and application developer</title>

  <meta name="description" content="Peter Mitchell helps build online businesses and is interested in working
with start-ups, small companies and individuals">
  <meta name="keywords" content="peterjmit, web development, web applications, web developer, php developer, javascript developer, ecommerce, PHP, Symfony2, Twig">
  <meta name="author" content="Peter Mitchell">
  <meta name="email" content="pete@peterjmit.com">

  <link href="/css/font.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  

  <link rel="shortcut icon" href="/favicon.ico">

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-40298804-1', 'peterjmit.com');
    ga('send', 'pageview');
    setTimeout(function() {
      window.onscroll = function() {
        window.onscroll = null;
        ga('send', 'event', 'scroll', 'read');
      }
    }, 5000);
  </script>
</head>

<body>

  <header id="top" role="banner">
    <div class="block">
      <a href="/" id="logo">
        <img src="/img/logo.svg" alt="site logo" title="Peter Mitchell is a web developer">
        <span>Peter Mitchell</span>
      </a>

      <nav id="nav" role="navigation">
        <a href="/blog/">Blog</a>
        <a href="mailto:pete@peterjmit.com?subject=Hi!">Say hello</a>
      </nav>
    </div>
  </header>

  <main id="main" role="main">
    <div class="content">
  <article class="post block">
    <header>
      <h1>
        Be careful with global variables in Symfony 2 Twig extensions
      </h1>
      <time datetime="Mon May 20 2013 00:00:00 GMT-0400 (EDT)">
        May 20th, 2013
      </time>
    </header>

    <hr>

    <p>I stumbled across a confusing error message while developing some new
functionality in one of my Symfony 2 based applications.</p>
<p>I was using some Behat scenarios to guide me through a payment listener that
emails a customer when their payment has been confirmed. Everything was working
fine until I tried to introduce a Twig template as the body of an email.</p>
<blockquote>
<p>[Symfony\Component\DependencyInjection\Exception\InactiveScopeException]
You cannot create a service (&quot;request&quot;) of an inactive scope (&quot;request&quot;).</p>
</blockquote>
<p>Initially I was stumped, the error message did not point me directly
to any code I was working with, nor anything I had recently looked at.</p>
<p>After a lot of head scratching I remembered a Twig extension that I had
written over a year ago. It helps to conditionally execute javascript
based on the users current location within the application (inspired by
Paul Irish&#39;s <a href="http://paulirish.com/2009/markup-based-unobtrusive-comprehensive-dom-ready-execution/">blog post</a>).</p>
<pre class="highlighted"><code class="php"><span class="comment">// ../Twig/Extension/MyExtension.php</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteInfo</span><span class="params">()</span>
{</span>
    <span class="variable">$request</span> = <span class="variable">$this</span>-&gt;container-&gt;get(<span class="string">'request'</span>);

    <span class="comment">// ... process the route information</span>

    <span class="keyword">return</span> <span class="variable">$routeInfo</span>;
}</code></pre>
<p>In order to make <code>$routeInfo</code> available to all my templates, I had decided
to make it to global.</p>
<pre class="highlighted"><code class="php"><span class="comment">// ../Twig/Extension/MyExtension.php</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getGlobals</span><span class="params">()</span>
{</span>
    <span class="keyword">return</span> [<span class="string">'route'</span> =&gt; <span class="variable">$this</span>-&gt;getRouteInfo()];
}</code></pre>
<p>The problem with this is that I have given my Twig environment a hard dependency
on the <code>Request</code> object. Every time I try and use Twig, it will make that <code>getGlobals</code>
call, which in turn will be trying to access the <code>Request</code> object.</p>
<p>This is why, in the CLI context where there is no <code>Request</code> object I was seeing
the inactive scope exception. While I would not necessarily take the above approach
again, the fix is quite easy &mdash; the Symfony 2 container provides a method
for checking if a scope is active or not, which means I can rewrite my
<code>getRouteInfo</code> method:</p>
<pre class="highlighted"><code class="php"><span class="comment">// ../Twig/Extension/MyExtension.php</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteInfo</span><span class="params">()</span>
{</span>
    <span class="keyword">if</span> (!<span class="variable">$this</span>-&gt;container-&gt;isScopeActive(<span class="string">'request'</span>)) {
        <span class="keyword">return</span> <span class="keyword">null</span>;
    }

    <span class="variable">$request</span> = <span class="variable">$this</span>-&gt;container-&gt;get(<span class="string">'request'</span>);

    <span class="comment">// ... </span>

    <span class="keyword">return</span> <span class="variable">$routeInfo</span>;
}</code></pre>
<p>I generally try and shy away from making variables global (in any context) and
this example reinforces my wariness of using <code>getGlobals</code> in Twig extensions.</p>


    <!-- twitter follow button -->
<a href="https://twitter.com/Peterjmit" class="twitter-follow-button" data-show-count="false">Follow @peterjmit</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<br>

<!-- twitter share button -->
<a href="https://twitter.com/share" class="twitter-share-button" data-text="Be careful with global variables in Symfony 2 Twig extensions" data-via="Peterjmit" data-dnt="true">Share on twitter</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


  </article>
</div>
  </main>

  <footer id="bottom" role="contentinfo">
    <div class="block">
      <p class="copyright">
        Peter Mitchell
        <span class="muted">
          &ndash; design by <a href="http://www.natalierauh.de/" target="_blank">Natalie Rauh</a>
        </span>
      </p>

      <ul class="social-icons">
  <li title="See my answers on Stackoverflow">
    <a target="_blank" href="http://stackoverflow.com/users/1041885/pete-mitchell">
      <i class="icon stackoverflow"></i>
    </a>
  </li>
  <li title="Take a look at my Github projects">
    <a target="_blank" href="https://github.com/peterjmit">
      <i class="icon github"></i>
    </a>
  </li>
  <li title="Follow me on Twitter">
    <a target="_blank" href="https://twitter.com/peterjmit">
      <i class="icon twitter"></i>
    </a>
  </li>
</ul>

    </div>
  </footer>

  

  
</body>
</html>
