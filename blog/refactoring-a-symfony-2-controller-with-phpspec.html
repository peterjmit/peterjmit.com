<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//www.google-analytics.com">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Refactoring a Symfony 2 Controller with PhpSpec :: Peter Mitchell :: Website and application developer</title>

  <meta name="description" content="Peter Mitchell helps build online businesses and is interested in working
with start-ups, small companies and individuals">
  <meta name="keywords" content="peterjmit, web development, web applications, web developer, php developer, javascript developer, ecommerce, PHP, BDD, Symfony2">
  <meta name="author" content="Peter Mitchell">
  <meta name="email" content="pete@peterjmit.com">

  <link href="/css/font.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  

  <link rel="shortcut icon" href="/favicon.ico">

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-40298804-1', 'peterjmit.com');
    ga('send', 'pageview');
    setTimeout(function() {
      window.onscroll = function() {
        window.onscroll = null;
        ga('send', 'event', 'scroll', 'read');
      }
    }, 5000);
  </script>
</head>

<body>

  <header id="top" role="banner">
    <div class="block">
      <a href="/" id="logo">
        <img src="/img/logo.svg" alt="site logo" title="Peter Mitchell is a web developer">
        <span>Peter Mitchell</span>
      </a>

      <nav id="nav" role="navigation">
        <a href="/blog/">Blog</a>
        <a href="mailto:pete@peterjmit.com?subject=Hi!">Say hello</a>
      </nav>
    </div>
  </header>

  <main id="main" role="main">
    <div class="content">
  <article class="post block">
    <header>
      <h1>
        Refactoring a Symfony 2 Controller with PhpSpec
      </h1>
      <time datetime="Wed Sep 04 2013 00:00:00 GMT-0400 (EDT)">
        Sep 4th, 2013
      </time>
    </header>

    <hr>

    <p>This is the second post in a series that looks at working with PhpSpec and Symfony 2.
In the <a href="/blog/getting-started-with-phpspec-and-symfony-2.html">first post</a> we saw how it was difficult to manage (and mock) all
the dependencies that come with a controller that extends the FrameworkBundle
Controller (you can see all the <a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2">code</a> and <a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2/commits/master">commits</a> for these posts on
<a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2">github</a>).</p>
<pre class="highlighted"><code class="php"><span class="keyword">namespace</span> Peterjmit\BlogBundle\Controller;

<span class="keyword">use</span> Symfony\Bundle\FrameworkBundle\Controller\Controller;

<span class="class"><span class="keyword">class</span> <span class="title">BlogController</span> <span class="keyword">extends</span> <span class="title">Controller</span>
{</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">indexAction</span><span class="params">()</span>
    {</span>
        <span class="variable">$entityManager</span> = <span class="variable">$this</span>-&gt;getDoctrine()-&gt;getManager();
        <span class="variable">$posts</span> = <span class="variable">$entityManager</span>-&gt;getRepository(<span class="string">'PeterjmitBlogBundle:Blog'</span>)-&gt;findAll();

        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;render(<span class="string">'PeterjmitBlogBundle:Blog:index.html.twig'</span>, <span class="keyword">array</span>(
            <span class="string">'posts'</span> =&gt; <span class="variable">$posts</span>
        ));
    }

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showAction</span><span class="params">(<span class="variable">$id</span>)</span>
    {</span>
        <span class="variable">$entityManager</span> = <span class="variable">$this</span>-&gt;getDoctrine()-&gt;getManager();
        <span class="variable">$post</span> = <span class="variable">$entityManager</span>-&gt;getRepository(<span class="string">'PeterjmitBlogBundle:Blog'</span>)-&gt;find(<span class="variable">$id</span>);

        <span class="keyword">if</span> (!<span class="variable">$post</span>) {
            <span class="keyword">throw</span> <span class="variable">$this</span>-&gt;createNotFoundException(sprintf(<span class="string">'Blog post %s was not found'</span>, <span class="variable">$id</span>));
        }

        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;render(<span class="string">'PeterjmitBlogBundle:Blog:show.html.twig'</span>, <span class="keyword">array</span>(
            <span class="string">'post'</span> =&gt; <span class="variable">$post</span>
        ));
    }
}</code></pre>
<h2 id="blogcontroller-knows-too-much">BlogController knows too much</h2>
<p>Since the previous post, I have added <code>showAction</code> to my controller, but I have
not specced it because I know that I the mocks are going to be annoying to write,
and I can see that I have duplicated some code from <code>indexAction</code>.</p>
<p>This is a good indicator for the need to refactor - in both the spec, and the
controller. In order to decide how to proceed we need to identify what the
behaviour of the controller should be, versus what it currently knows.</p>
<p>So we know that in our controller is called during a request, and should
return a response object. We also want to show a list of, or a single blog post
(depending on the action called).</p>
<p>However we can see that our controller contains more behaviour than that, it knows
how to:</p>
<ol>
<li>Get the templating and doctrine services from the container</li>
<li>Get a &quot;manager&quot; from the doctrine service</li>
<li>Get a named repository from the &quot;manager&quot;</li>
<li>Find blog post objects via the repository</li>
<li>Render a named template with the blog posts and return the result</li>
</ol>
<p>Reviewing that list, only numbers 4 and 5 really seem to fall in line with
our objective, so our goal will be to remove behaviours 1-3 from our controller
<sup>1</sup>.</p>
<h2 id="let-blogcontroller-focus-on-responding-to-a-request">Let BlogController focus on responding to a request</h2>
<p>Having the container is convenient when we aren&#39;t writing tests, but as soon as we
start having to mock the container, our specs can get a lot less fun to write.
Therefore we are going to lose our dependency on
<code>Symfony\Bundle\FrameworkBundle\Controller\Controller</code>. To fix our failing tests
we can construct our controller with templating and doctrine instead as shown
in <a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2/commit/3d5de3432698af520eb30c915e278d39bf53093a">this commit</a>.</p>
<p>That commit however does not go far enough, so lets <a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2/commit/4a87e1d447c106e479b335a0a95c81d4feddfefa">get rid of doctrine</a> too.
We do this by introducing the repository <code>BlogRepository</code> directly, providing
the controller with the blog posts that it needs.</p>
<p><em>edit: after some feedback I simplified the introduction of <code>BlogManagerInterface</code>
by switching it to directly injecting the repository <a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2/commit/d930a806641a10706c2ed2d61219de660a8e93bb">in this commit</a></em></p>
<pre class="highlighted"><code class="php"><span class="comment">// ...</span>
<span class="keyword">use</span> Peterjmit\BlogBundle\Doctrine\BlogRepository;
<span class="keyword">use</span> Symfony\Bundle\FrameworkBundle\Templating\EngineInterface;

<span class="class"><span class="keyword">class</span> <span class="title">BlogController</span>
{</span>
    <span class="keyword">private</span> <span class="variable">$repository</span>;
    <span class="keyword">private</span> <span class="variable">$templating</span>;

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BlogRepository <span class="variable">$repository</span>, EngineInterface <span class="variable">$templating</span>)</span>
    {</span>
        <span class="variable">$this</span>-&gt;repository = <span class="variable">$repository</span>;
        <span class="variable">$this</span>-&gt;templating = <span class="variable">$templating</span>;
    }

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">indexAction</span><span class="params">()</span>
    {</span>
        <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;repository-&gt;findAll();

        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;templating-&gt;renderResponse(<span class="string">'PeterjmitBlogBundle:Blog:index.html.twig'</span>, <span class="keyword">array</span>(
            <span class="string">'posts'</span> =&gt; <span class="variable">$posts</span>
        ));
    }

    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showAction</span><span class="params">(<span class="variable">$id</span>)</span>
    {</span>
        <span class="variable">$post</span> = <span class="variable">$this</span>-&gt;repository-&gt;find(<span class="variable">$id</span>);

        <span class="comment">// ...</span>

        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;templating-&gt;renderResponse(<span class="string">'PeterjmitBlogBundle:Blog:show.html.twig'</span>, <span class="keyword">array</span>(
            <span class="string">'post'</span> =&gt; <span class="variable">$post</span>
        ));
    }
}</code></pre>
<p>By now our spec is looking a lot less <em>difficult</em> to work with, so we can introduce
<a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2/blob/d930a806641a10706c2ed2d61219de660a8e93bb/spec/Peterjmit/BlogBundle/Controller/BlogControllerSpec.php#L47">some</a> <a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2/blob/d930a806641a10706c2ed2d61219de660a8e93bb/spec/Peterjmit/BlogBundle/Controller/BlogControllerSpec.php#L65">examples</a> for <code>showAction</code></p>
<pre class="highlighted"><code class="php"><span class="comment">// ...</span>

<span class="class"><span class="keyword">class</span> <span class="title">BlogControllerSpec</span> <span class="keyword">extends</span> <span class="title">ObjectBehavior</span>
{</span>
    <span class="function"><span class="keyword">function</span> <span class="title">let</span><span class="params">(
        BlogRepository <span class="variable">$repository</span>,
        EngineInterface <span class="variable">$templating</span>
    )</span> {</span>
        <span class="variable">$this</span>-&gt;beConstructedWith(<span class="variable">$repository</span>, <span class="variable">$templating</span>);
    }

    <span class="function"><span class="keyword">function</span> <span class="title">it_is_initializable</span><span class="params">()</span>
    {</span>
        <span class="variable">$this</span>-&gt;shouldHaveType(<span class="string">'Peterjmit\BlogBundle\Controller\BlogController'</span>);
    }

    <span class="function"><span class="keyword">function</span> <span class="title">it_should_respond_to_index_action</span><span class="params">(
        BlogRepository <span class="variable">$repository</span>,
        EngineInterface <span class="variable">$templating</span>,
        Response <span class="variable">$mockResponse</span>
    )</span> {</span>
        <span class="variable">$repository</span>-&gt;findAll()-&gt;willReturn(<span class="keyword">array</span>(<span class="string">'An array'</span>, <span class="string">'of blog'</span>, <span class="string">'posts!'</span>));

        <span class="variable">$templating</span>
            -&gt;renderResponse(
                <span class="string">'PeterjmitBlogBundle:Blog:index.html.twig'</span>,
                <span class="keyword">array</span>(<span class="string">'posts'</span> =&gt; <span class="keyword">array</span>(<span class="string">'An array'</span>, <span class="string">'of blog'</span>, <span class="string">'posts!'</span>))
            )
            -&gt;willReturn(<span class="variable">$mockResponse</span>)
        ;

        <span class="variable">$response</span> = <span class="variable">$this</span>-&gt;indexAction();

        <span class="variable">$response</span>-&gt;shouldHaveType(<span class="string">'Symfony\Component\HttpFoundation\Response'</span>);
    }
}</code></pre>
<p>Check out the full <a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2/blob/d930a806641a10706c2ed2d61219de660a8e93bb/spec/Peterjmit/BlogBundle/Controller/BlogControllerSpec.php">specification</a> and <a href="https://github.com/peterjmit/getting-started-with-phpspec-and-symfony-2/blob/d930a806641a10706c2ed2d61219de660a8e93bb/src/Peterjmit/BlogBundle/Controller/BlogController.php">controller</a> after this round of
refactoring.</p>
<p>The behaviour of our controller is now more tightly defined and our logic for
fetching blog posts is now re-usable in other areas of the application. While
some would argue this approach is a lot more verbose, we have gained increased
testability, code re-use and we have gone some way to decoupling our Controller
from Symfony 2.</p>
<p>If you hadn&#39;t already realised, in order for our controller to work within Symfony
we will have to <a href="http://symfony.com/doc/current/cookbook/controller/service.html">define it as a service</a> and this should hopefully
demonstrate some of the advantages (in terms of maintainability &amp; testability)
of doing so.</p>
<p>This is not the only possible approach to making controllers within Symfony
more testable and arguably it is one of the more verbose, you can also look at
the following for removing logic from your controllers:</p>
<ul>
<li><a href="http://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/index.html">Annotations provided by SensioFrameworkExtraBundle</a></li>
<li><a href="http://whitewashing.de/2013/02/19/extending_symfony2__paramconverter.html">Parameter converters</a></li>
<li><a href="http://www.whitewashing.de/2013/06/27/extending_symfony2__controller_utilities.html">Controller utility service</a></li>
</ul>
<h4 id="see-also">See also</h4>
<ul>
<li><a href="http://www.slideshare.net/marcello.duarte/emergent-design-with-phpspec">Emergent design with PhpSpec</a></li>
</ul>
<p><br></p>
<p><small></p>
<ol>
<li>This problem is formalised by the <a href="http://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a> and this principal is
very useful for identifying targets for refactoring/simplification of your code
</small></li>
</ol>


    <!-- twitter follow button -->
<a href="https://twitter.com/Peterjmit" class="twitter-follow-button" data-show-count="false">Follow @peterjmit</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<br>

<!-- twitter share button -->
<a href="https://twitter.com/share" class="twitter-share-button" data-text="Refactoring a Symfony 2 Controller with PhpSpec" data-via="Peterjmit" data-dnt="true">Share on twitter</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


  </article>
</div>
  </main>

  <footer id="bottom" role="contentinfo">
    <div class="block">
      <p class="copyright">
        Peter Mitchell
        <span class="muted">
          &ndash; design by <a href="http://www.natalierauh.de/" target="_blank">Natalie Rauh</a>
        </span>
      </p>

      <ul class="social-icons">
  <li title="See my answers on Stackoverflow">
    <a target="_blank" href="http://stackoverflow.com/users/1041885/pete-mitchell">
      <i class="icon stackoverflow"></i>
    </a>
  </li>
  <li title="Take a look at my Github projects">
    <a target="_blank" href="https://github.com/peterjmit">
      <i class="icon github"></i>
    </a>
  </li>
  <li title="Follow me on Twitter">
    <a target="_blank" href="https://twitter.com/peterjmit">
      <i class="icon twitter"></i>
    </a>
  </li>
</ul>

    </div>
  </footer>

  

  
</body>
</html>
